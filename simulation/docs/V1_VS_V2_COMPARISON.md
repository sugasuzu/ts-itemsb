# シミュレーション v1 vs v2 比較レポート

## 📊 GBPAUD 20ルール（40 total）比較結果

| 指標 | v1（旧版・問題あり） | v2（最適化版） | 差分 |
|------|---------------------|---------------|------|
| **テスト期間** | 2010-2025（全期間） | 2021-2025（未来データのみ） | ✅ 正しい分割 |
| **総取引数** | 63,716 | 1,245 | -62,471 (98%減) |
| **シグナル重複** | あり（同時刻複数実行） | なし（1時点1トレード） | ✅ 現実的 |
| **トランザクションコスト** | なし | 0.04%/取引 | ✅ 現実的 |
| | | | |
| **勝率** | 49.92% | 50.44% | +0.52% |
| **BUY勝率** | 50.21% | 50.40% | +0.19% |
| **SELL勝率** | 49.62% | 66.67% | +17.05% ⚠️ |
| | | | |
| **総利益（コスト前）** | N/A | +20.112% | - |
| **総利益（コスト後）** | +163.619% | **+19.614%** | **-144.005%** ⚠️⚠️⚠️ |
| **BUY利益** | +237.253% | +18.492% | -218.761% |
| **SELL利益** | -73.634% | +1.122% | +74.756% |
| | | | |
| **平均利益/取引（コスト前）** | N/A | +0.0162% | - |
| **平均利益/取引（コスト後）** | +0.0026% | **+0.0158%** | +0.0132% |
| **最大ドローダウン** | -97.556% | **-13.756%** | +83.800% ✅ |

## 🔍 主要な発見

### 1. **総利益の劇的な減少**
```
v1: +163.619% → v2: +19.614%

減少率: -88.0%
```

#### 原因分析
1. **データリーケージの排除**
   - v1: 学習データとテスト期間が重複 → 過度に楽観的
   - v2: 未来データのみでテスト → 現実的

2. **シグナル重複排除**
   - v1: 同時刻に複数トレード（非現実的）
   - v2: 1時点1トレードのみ → 取引機会98%減

3. **トランザクションコスト**
   - v1: コスト無視（理想的条件）
   - v2: 0.04%/取引のコスト → 累計49.8%のコスト

### 2. **取引回数の大幅減少**
```
v1: 63,716取引（2010-2025, 15年間）
v2:  1,245取引（2021-2025, 5年間）

期間比: 5年 / 15年 = 33.3%
実際比: 1,245 / 63,716 = 1.95%

→ 重複排除により取引機会が激減
```

### 3. **勝率の安定性**
```
v1: 49.92%
v2: 50.44%

差: わずか +0.52%
```

**重要**: 両方とも **50%前後** → **ランダムに近い**

### 4. **BUY vs SELL の逆転**
```
         v1           v2
BUY:   +237.253%  →  +18.492%
SELL:   -73.634%  →   +1.122%

SELLが改善！（負 → 正）
```

#### 理由
- v1: 全期間でテスト → 学習期間の偏り（上昇トレンド）が影響
- v2: 未来期間（2021-2025）のみ → より中立的な期間

### 5. **リスク（ドローダウン）の大幅改善**
```
v1: -97.556%（資産がほぼ半減する瞬間）
v2: -13.756%（許容範囲内）

改善: +83.8ポイント
```

## ⚠️ 最も重要な結論

### v1の結果は**使用不可**
```
理由:
1. ❌ データリーケージ（未来予知バイアス）
2. ❌ 非現実的な重複シグナル実行
3. ❌ トランザクションコスト無視
4. ❌ 過度に楽観的な結果（+163%）
```

### v2の結果が**真の性能**
```
現実的なパフォーマンス:
✅ 総利益: +19.614%（5年間で）
✅ 年率: 約 +3.6%/年
✅ 勝率: 50.44%（ランダムレベル）
✅ ドローダウン: -13.756%（許容範囲）
```

## 📈 v2の詳細分析

### トップ5ルール（総利益順）

| ルール | シグナル | 取引数 | 勝率 | 総利益 |
|--------|---------|--------|------|--------|
| 2121 | BUY | 570 | 50.88% | +6.559% |
| 10010 | BUY | 17 | 58.82% | +5.499% |
| 7882 | BUY | 5 | 100.00% | +2.910% |
| 3358 | BUY | 7 | 57.14% | +2.035% |
| 350 | BUY | 32 | 56.25% | +1.232% |

**観察**:
- Rule 2121が大半の取引（570/1245 = 45.8%）
- サポート数優先により、高サポートルールに集中
- 取引数が少ないルール（5-17回）は統計的に不安定

### ワースト3ルール

| ルール | シグナル | 取引数 | 勝率 | 総利益 |
|--------|---------|--------|------|--------|
| 15411 | BUY | 299 | 46.15% | -4.359% |
| 3236 | BUY | 31 | 41.94% | -1.507% |
| 14956 | BUY | 17 | 47.06% | -0.968% |

**問題**:
- Rule 15411が多数の取引（299回）で大きな損失
- 学習期間で良かったルールが未来期間で失敗
- オーバーフィッティングの証拠

## 💡 実戦投入の評価

### シナリオ1: そのまま実戦投入
```
期待リターン: 年率 +3.6%
リスク: ドローダウン -13.756%

評価: ⚠️ 微妙
理由:
- 勝率50% = ランダムと同等
- リターンが低い（定期預金より少し良い程度）
- トランザクションコストでさらに悪化する可能性
```

### シナリオ2: ルール選択の改善
```
対策:
1. 悪いルール（15411, 3236等）を除外
2. 良いルール（2121, 10010等）のみ使用
3. 機械学習でルール選択を最適化

期待効果:
- 総利益 +19.6% → +25-30%（推定）
- ドローダウン改善
```

### シナリオ3: 他の通貨ペアと組み合わせ
```
ポートフォリオアプローチ:
- GBPAUD: +19.6%
- EURAUD: ?%
- USDJPY: ?%
...

リスク分散効果で安定性向上
```

## 🎯 改善提案（次のステップ）

### 優先度 HIGH
1. **悪いルールのフィルタリング**
   ```python
   # v2の結果から、未来期間で悪かったルールを除外
   bad_rules = [15411, 3236, 14956]
   filtered_rules = [r for r in rules if r['rule_id'] not in bad_rules]
   ```

2. **ウォークフォワード分析**
   ```
   Period 1: Train 2010-2015 → Test 2016
   Period 2: Train 2011-2016 → Test 2017
   Period 3: Train 2012-2017 → Test 2018
   ...
   → ルールの頑健性を検証
   ```

3. **機械学習によるルール選択**
   ```python
   # 特徴量: support_count, X_mean, SNR, etc.
   # 目標: 未来期間での利益
   model = RandomForestClassifier()
   model.fit(features_train, is_profitable_train)
   selected_rules = model.predict(features_test)
   ```

### 優先度 MEDIUM
4. **ストップロス・利確の追加**
   ```python
   if profit < -1.0:  # -1%で損切り
       exit_trade()
   if profit > 2.0:  # +2%で利確
       exit_trade()
   ```

5. **ポジションサイジング**
   ```python
   # ケリー基準等を使用
   kelly_fraction = 0.012  # 1.2%
   position_size = capital * kelly_fraction
   ```

6. **他の通貨ペアでの検証**
   ```bash
   python3 simulation/rule_simulator_v2.py EURAUD --top 20
   python3 simulation/rule_simulator_v2.py USDJPY --top 20
   python3 simulation/rule_simulator_v2.py GBPJPY --top 20
   ```

## 📋 結論

### v1 vs v2 まとめ

| 項目 | v1 | v2 |
|------|----|----|
| **データリーケージ** | ❌ あり | ✅ なし |
| **トランザクションコスト** | ❌ 無視 | ✅ 考慮 |
| **シグナル重複** | ❌ 複数実行 | ✅ 1時点1つ |
| **総利益** | +163.6% | +19.6% |
| **現実性** | ❌ 過度に楽観的 | ✅ 現実的 |
| **実戦投入** | ❌ 不可 | ⚠️ 要改善 |

### 最終評価

**v2（最適化版）の結果**:
```
✅ 正しい評価手法
✅ 現実的な性能（+19.6%、5年間）
⚠️ 勝率50% = ランダムレベル
⚠️ 実戦投入には更なる改善が必要
```

**推奨アクション**:
1. ✅ v1は使用禁止（参考値のみ）
2. ✅ v2を標準とする
3. ⚠️ 悪いルールを除外
4. ⚠️ ウォークフォワード分析で頑健性確認
5. ⚠️ 他の通貨ペアでも検証

**実戦投入判断**:
```
現状: 保留（要改善）

理由:
- 勝率50% = 予測力が疑問
- リターンが低い（年率3.6%）
- 改善の余地あり

次のステップ:
→ ルール選択の最適化
→ 複数通貨ペアでポートフォリオ構築
→ 機械学習による高度化
```
