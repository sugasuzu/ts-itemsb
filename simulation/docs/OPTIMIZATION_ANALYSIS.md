# シミュレーション最適化検討レポート

## 🔍 現状のシミュレーション方式

### 基本設計
```python
時点t:
  全ルール（20-40個）をチェック
  → 条件マッチ
  → シグナル発生
  → t+1でトレード実行
  → 損益確定
```

### 主な特徴
- **データセット**: 極値データ（|X| ≥ 1.0）でルール発見
- **テストデータ**: 全履歴データ（4120レコード）
- **トレード実行**: 全シグナルを実行（重複あり）
- **保有期間**: 固定1時点（t → t+1）
- **ポジションサイズ**: 全て同一

## ⚠️ 最適化に関する重大な問題

### 問題1: **データリーケージ（Look-Ahead Bias）**

#### **現在の実装**
```
学習データ: forex_data/extreme_gnminer/{PAIR}_{direction}.txt (極値のみ)
テストデータ: forex_data/gnminer_individual/{PAIR}.txt (全データ)
```

#### **問題点**
✅ **データセットは分離されている**: 極値データ vs 全データ
❌ **時間的には重複している**: 同じ期間（2010-2025）

```
時間軸:
[2010年1月]==================[2025年10月]
    ↓ 学習データ（極値のみ）↓
    ↓ テストデータ（全データ）↓
    ← 完全に重複！ →
```

#### **正しいアプローチ**
```
時間軸:
[2010年1月]======[2020年12月]|[2021年1月]======[2025年10月]
← 学習期間（in-sample） →   |← テスト期間（out-of-sample）→
    ルール発見                    シミュレーション実行
```

#### **影響**
- **現在**: 学習データとテストデータが時間的に重複
- **結果**: 過度に楽観的なパフォーマンス
- **実戦**: 未来データでは性能が大幅に低下する可能性

### 問題2: **オーバーフィッティング**

#### **現象**
```
10ルール: +68.944%  (勝率 49.86%)
20ルール: +163.619% (勝率 49.92%)
30ルール: +233.440% (勝率 49.87%)
40ルール: +133.101% (勝率 49.74%)  ← 性能低下
```

#### **分析**
- 勝率は全て **50%前後** → ほぼランダム
- ルール数を増やすと総利益が増加 → 取引回数が増えただけ
- 40ルールで性能低下 → 質の低いルールが混入

#### **問題**
1. **勝率50% = コイン投げと同等**
   - ルールに本質的な予測力がない可能性
   - たまたま過去データに合致しただけ

2. **ExtremeScore、SNRの意味**
   - これらの指標が高くても実戦で機能しない
   - 極値データに過剰適合している

### 問題3: **複数シグナルの重複**

#### **現在の実装**
```python
時点t=100:
  Rule 10218: BUYシグナル → トレード1
  Rule 8017:  BUYシグナル → トレード2
  Rule 15628: BUYシグナル → トレード3
  ...
  → 同じ時点で10-20個のトレードを実行
```

#### **問題点**
- **非現実的**: 実際には同じ時点で複数ポジションを取らない
- **リスク過大**: 同じ方向に大量のポジション
- **資金管理なし**: 破産リスクを考慮していない

#### **実戦での課題**
```
時点t: 10個のBUYシグナル → 全て実行？
  → 資金不足
  → リスク集中
  → ポートフォリオとして不健全
```

### 問題4: **トランザクションコスト無視**

#### **現在の実装**
```python
profit = actual_X  # BUYの場合
```

#### **実戦では**
```python
profit = actual_X - spread - commission - slippage
# 例: 0.5% - 0.02% - 0.01% - 0.01% = 0.46%
```

#### **影響**
- 平均利益/取引: **+0.0026%**（20ルール）
- スプレッド: **0.02%程度**（通常）
- **結果**: 利益がほぼ消失する

### 問題5: **SELLルールの異常な損失**

#### **データ**
```
10ルール:
  BUY:  +123.721%
  SELL: -54.778%  ← 損失

40ルール:
  BUY:  +356.960%
  SELL: -223.859%  ← 巨大な損失
```

#### **原因の可能性**
1. **方向性バイアス**: 学習期間が上昇トレンド
2. **極値データの偏り**: positive/negativeの非対称性
3. **ルール発見の失敗**: SELLルールの質が低い

## 📊 最適化の可能性を検証

### 検証1: 勝率とランダム性

#### **帰無仮説**: ルールの予測力はランダム
```
勝率 = 50%（コイン投げ）
観測値: 49.86% - 49.92%
```

#### **統計検定**
```python
# サンプル: 63,716取引、勝率49.92%
# 期待値: 50%
# 標準偏差: sqrt(0.5 * 0.5 / 63716) = 0.00198

z = (0.4992 - 0.5000) / 0.00198 = -0.404
p-value > 0.05
```

**結論**: 勝率50%から統計的に有意に離れていない
→ **ランダムと区別できない**

### 検証2: シャープレシオ

#### **定義**
```
シャープレシオ = (平均リターン - リスクフリーレート) / リターンの標準偏差
```

#### **推定値**（20ルール）
```
平均リターン/取引: +0.0026%
標準偏差（推定）:   ~0.43%（平均勝ち・負けから推測）
リスクフリーレート: 0%

シャープレシオ = 0.0026 / 0.43 = 0.006
```

**基準**:
- 0.5以上: まあまあ
- 1.0以上: 良い
- 2.0以上: 優秀
- **0.006**: ほぼゼロ（ランダム）

### 検証3: 時系列での安定性

#### **累積リターンチャートの観察**
- 大きな上昇（2015-2020頃）
- 大きな下落（2020-2023頃）
- 最近は横ばい

**問題**:
- 期間によってパフォーマンスが大きく異なる
- 安定して機能していない
- 市場環境依存が強い

## 🎯 真の最適化のための提案

### 提案1: **時間分割によるバックテスト** ⭐ 最重要

#### **実装方法**
```python
# Phase 1: ルール発見（In-Sample）
学習期間: 2010年1月 - 2020年12月（約11年）
→ この期間の極値データでルール発見

# Phase 2: シミュレーション（Out-of-Sample）
テスト期間: 2021年1月 - 2025年10月（約5年）
→ この期間の全データでシミュレーション
```

#### **期待される結果**
- より現実的なパフォーマンス評価
- 実戦での予測精度の検証
- オーバーフィッティングの検出

#### **実装**
```python
class TimeBasedBacktest:
    def __init__(self, train_end='2020-12-31', test_start='2021-01-01'):
        self.train_end = train_end
        self.test_start = test_start

    def split_data(self, data_df):
        train = data_df[data_df['T'] <= self.train_end]
        test = data_df[data_df['T'] >= self.test_start]
        return train, test
```

### 提案2: **ウォークフォワード分析**

#### **概念**
```
期間1: [2010-2015] 学習 → [2016] テスト
期間2: [2011-2016] 学習 → [2017] テスト
期間3: [2012-2017] 学習 → [2018] テスト
...
```

#### **利点**
- 時系列での頑健性を検証
- 市場環境の変化に対する適応力を評価
- より信頼性の高い性能指標

### 提案3: **シグナル統合（重複排除）**

#### **現在**
```python
時点t: 10個のBUYシグナル → 全て実行（非現実的）
```

#### **改善案A: 最良シグナル選択**
```python
時点t: 10個のBUYシグナル
→ ExtremeScoreが最も高いルールのみ実行
```

#### **改善案B: 投票メカニズム**
```python
時点t:
  BUYシグナル: 8個
  SELLシグナル: 2個
  → BUYの方が多い → BUYトレード1つのみ実行
```

#### **改善案C: ポートフォリオアプローチ**
```python
時点t: 複数シグナル → 資金を分散
  Rule 10218 (BUY): 資金の10%
  Rule 8017 (BUY):  資金の10%
  ...
  最大: 資金の50%まで
```

### 提案4: **トランザクションコスト考慮**

#### **実装**
```python
def calculate_profit_with_costs(actual_x, signal_type):
    spread = 0.0002  # 0.02% (スプレッド)
    commission = 0.0001  # 0.01% (手数料)
    slippage = 0.0001  # 0.01% (スリッページ)

    total_cost = spread + commission + slippage  # 0.04%

    if signal_type == 'BUY':
        profit = actual_x - total_cost
    else:  # SELL
        profit = -actual_x - total_cost

    return profit
```

#### **影響**
- 平均利益/取引: +0.0026% → **-0.0374%**（赤字）
- 実戦では機能しない可能性が高い

### 提案5: **リスク管理機能**

#### **A. ストップロス**
```python
if profit < -1.0:  # -1%で損切り
    exit_trade()
```

#### **B. 利益確定**
```python
if profit > 2.0:  # +2%で利確
    exit_trade()
```

#### **C. ポジションサイジング**
```python
# ケリー基準
win_rate = 0.50
avg_win = 0.43
avg_loss = -0.42

kelly = win_rate - (1 - win_rate) / (avg_win / abs(avg_loss))
# = 0.50 - 0.50 / 1.024 = 0.012 = 1.2%

→ 資金の1.2%のみをリスクにさらす
```

### 提案6: **統計的有意性検定**

#### **モンテカルロシミュレーション**
```python
# ランダムトレードを10,000回シミュレート
for i in range(10000):
    random_trades = generate_random_trades(n=63716, win_rate=0.50)
    random_return = calculate_total_return(random_trades)
    random_returns.append(random_return)

# 実際のリターンが上位5%に入るか？
actual_return = 163.619%
percentile = np.percentile(random_returns, 95)

if actual_return > percentile:
    print("統計的に有意")
else:
    print("ランダムと区別できない")
```

### 提案7: **機械学習による最適化**

#### **ルール選択の最適化**
```python
from sklearn.ensemble import RandomForestClassifier

# 特徴量: ルールの統計指標
X = rules_df[['support_count', 'X_mean', 'X_sigma', 'SNR', 'Extremeness']]
y = rules_df['is_profitable']  # 実際に利益を出したか

# 学習
model = RandomForestClassifier()
model.fit(X_train, y_train)

# ルール選択
selected_rules = model.predict(X_test)
```

## 📋 実装優先順位

### Phase 1: 緊急（最重要）
1. ✅ **時間分割バックテスト** - データリーケージを排除
2. ✅ **トランザクションコスト** - 現実的な評価
3. ✅ **シグナル重複排除** - 1時点1トレードに制限

### Phase 2: 重要
4. ⭐ **ウォークフォワード分析** - 頑健性検証
5. ⭐ **統計的有意性検定** - ランダム性の検証
6. ⭐ **リスク管理機能** - ストップロス・利確

### Phase 3: 改善
7. 🔧 **ポートフォリオ最適化** - 資金配分
8. 🔧 **機械学習統合** - ルール選択の高度化
9. 🔧 **市場環境分析** - トレンド・レンジ判定

## 🎓 結論

### 現在のシミュレーション
- ❌ **データリーケージあり** - 過度に楽観的
- ❌ **勝率50% = ランダム** - 予測力が疑問
- ❌ **コスト無視** - 実戦では赤字の可能性
- ❌ **非現実的な設定** - 複数シグナル同時実行

### 真の最適化には
1. **時間分割** - 学習期間とテスト期間を完全分離
2. **現実的な設定** - コスト・リスク管理・1時点1トレード
3. **統計検証** - ランダム性との比較
4. **頑健性確認** - 複数期間での検証

### 次のステップ
**最優先**: 時間分割バックテストの実装
→ これにより真の性能が明らかになる
→ 実戦投入の可否を判断できる

現在のシミュレーションは **「参考値」** として扱うべきで、
実戦投入には **時間分割バックテスト** が必須です。
