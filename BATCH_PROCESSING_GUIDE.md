# 単一プログラムによる全銘柄一括処理ガイド

## 📋 概要

**GNMiner Phase 2** は、単一のプログラム実行で日経225全銘柄（225銘柄）を自動的に順次処理できるように拡張されました。

シェルスクリプト不要で、**1回のコマンド実行で全銘柄を処理**できます。

---

## 🚀 クイックスタート

### 1. コンパイル

```bash
gcc -o main main.c -lm
```

### 2. 実行方法

#### **方法A: 全銘柄を一括処理（デフォルト）**

```bash
./main
```

または

```bash
./main --all
```

これだけで、日経225の全225銘柄が自動的に順次処理されます！

#### **方法B: 単一銘柄のみ処理**

```bash
./main 7203    # トヨタのみ
./main 9984    # ソフトバンクのみ
./main 6758    # ソニーのみ
```

---

## 📊 処理の流れ

### 全銘柄モード（./main または ./main --all）

```
1. バッチ処理開始メッセージ表示
2. ログファイル作成（batch_run_YYYYMMDD_HHMMSS.log）
3. 各銘柄を順次処理：
   [1/225] 1332 → 処理 → 成功/失敗を記録
   [2/225] 1333 → 処理 → 成功/失敗を記録
   ...
   [225/225] 2432 → 処理 → 成功/失敗を記録
4. 最終サマリー表示（成功数、失敗数、実行時間）
```

### 単一銘柄モード（./main <銘柄コード>）

```
1. 指定銘柄の処理開始メッセージ表示
2. ログファイル作成
3. 指定銘柄のみ処理
4. 結果サマリー表示
```

---

## 📁 出力ファイル構造

### 銘柄ごとの出力ディレクトリ

```
output_1332/                    # 銘柄1332の結果
├── IL/                         # ルールリスト
├── IA/                         # 分析レポート
├── IB/                         # バックアップ
├── pool/                       # ルールプール
├── doc/                        # 統計ファイル
└── vis/                        # 可視化データ

output_1333/                    # 銘柄1333の結果
├── IL/
├── IA/
└── ...

... (合計225個のディレクトリ)
```

### バッチログファイル

プログラム実行時に自動作成されます：

```
batch_run_20250117_143025.log   # 実行日時付きログファイル
```

**ログファイルの内容:**
- 処理開始時刻
- 各銘柄の処理結果（SUCCESS/FAILED）
- 最終サマリー（成功数、失敗数、実行時間）

---

## 💻 実行例

### 例1: 全銘柄を一括処理

```bash
$ ./main

==================================================
  GNMiner Phase 2 - Batch Processing Mode
==================================================
Total Stocks: 225 (Nikkei 225)
Log File: batch_run_20250117_143025.log
==================================================

==================================================
  [1/225] Processing: 1332
==================================================

##################################################
##  Processing Stock: 1332
##################################################

=== Path Configuration ===
Stock Code: 1332
Input File: nikkei225_data/gnminer_individual/1332.txt
Output Dir: output_1332
=========================

... (処理続行)

✓ SUCCESS: 1332

--------------------------------------------------
Progress: 1/225 (0.4%)
Success: 1 | Failed: 0
--------------------------------------------------

==================================================
  [2/225] Processing: 1333
==================================================

... (以降同様に225銘柄を処理)
```

### 例2: 単一銘柄のみ処理

```bash
$ ./main 7203

==================================================
  GNMiner Phase 2 - Single Stock Mode
==================================================
Stock Code: 7203
Log File: batch_run_20250117_144530.log
==================================================

##################################################
##  Processing Stock: 7203
##################################################

... (処理実行)

##################################################
##  Stock 7203 Completed (652.34s)
##################################################

==================================================
  Batch Processing Complete
==================================================
Total Time: 652.34s (10.9m)
Success: 1 stocks
Failed: 0 stocks
Success Rate: 100.0%
Log File: batch_run_20250117_144530.log
==================================================
```

---

## ⏱️ 実行時間の目安

| 処理内容 | 銘柄数 | 推定時間 |
|---------|-------|---------|
| 単一銘柄 | 1 | 約5-10分 |
| 10銘柄 | 10 | 約50分-1.5時間 |
| 全銘柄 | 225 | 約18-40時間 |

※ 実行時間はマシンスペック、データサイズ、パラメータ設定に依存します

---

## 📈 進捗状況の確認

### 方法1: 画面出力を確認

プログラムは自動的に以下を表示します：

```
Progress: 50/225 (22.2%)
Success: 48 | Failed: 2
```

### 方法2: ログファイルを確認

別のターミナルで：

```bash
tail -f batch_run_*.log
```

### 方法3: 出力ディレクトリ数を確認

```bash
ls -d output_* | wc -l
```

---

## 🛑 処理の中断と再開

### 中断方法

```bash
Ctrl+C
```

### 再開方法

現在のところ、プログラムは**自動的な再開機能がありません**。

中断した場合は、以下の方法で残りの銘柄を処理してください：

1. **処理済み銘柄を確認**:
   ```bash
   ls -d output_* | sed 's/output_//' | sort > processed.txt
   ```

2. **未処理銘柄を特定し、個別実行**:
   ```bash
   # 例: 未処理の銘柄を1つずつ実行
   ./main 7203
   ./main 9984
   # ...
   ```

---

## 🎛️ パラメータ調整

処理時間を短縮したい場合は、`main.c`のパラメータを調整してください：

```c
#define Generation 201        // 進化世代数（201→100に減らすと高速化）
#define Ntry 100             // 試行回数（100→50に減らすと高速化）
```

変更後は再コンパイルが必要です：

```bash
gcc -o main main.c -lm
```

---

## 🔍 処理済み銘柄の確認

### 成功した銘柄の一覧

```bash
ls -d output_* | sed 's/output_//' | sort
```

### 失敗した銘柄の確認

ログファイルから：

```bash
grep "FAILED" batch_run_*.log
```

---

## 📝 日経225銘柄リスト

プログラムには以下の225銘柄が組み込まれています：

```
1332, 1333, 1605, 1721, 1801, 1802, 1803, 1808, 1812, 1925,
1928, 1963, 2002, 2269, 2282, 2501, 2502, 2503, 2531, 2801,
2802, 2871, 2914, 3101, 3103, 3401, 3402, 3861, 3863, 3405,
... (合計225銘柄)
```

完全なリストは `main.c` の `NIKKEI_225_STOCKS[]` 配列で確認できます。

---

## 🐛 トラブルシューティング

### Q1: コンパイルエラーが出る

```bash
# math ライブラリを明示的にリンク
gcc -o main main.c -lm
```

### Q2: データファイルが見つからない

```bash
# データディレクトリの確認
ls nikkei225_data/gnminer_individual/

# ファイルが存在するか確認
ls nikkei225_data/gnminer_individual/7203.txt
```

### Q3: 処理が途中で停止する

- ディスク容量を確認：225銘柄分の出力には大量のディスクが必要
- メモリ使用状況を確認：`top`コマンドで確認

### Q4: 特定の銘柄だけ失敗する

ログファイルでエラー詳細を確認：

```bash
grep -A 10 "FAILED: <銘柄コード>" batch_run_*.log
```

---

## 💡 Tips

### 1. バックグラウンド実行

長時間実行の場合は、バックグラウンドで実行：

```bash
nohup ./main > output.log 2>&1 &

# 進捗確認
tail -f output.log
```

### 2. 複数マシンでの並列処理

複数のマシンがある場合は、銘柄を分割して並列実行：

```bash
# マシン1: 最初の75銘柄
./main 1332
./main 1333
# ...

# マシン2: 次の75銘柄
./main 7203
./main 9984
# ...

# マシン3: 残りの75銘柄
./main 8601
./main 9984
# ...
```

### 3. 処理結果の集計

全銘柄の結果を集計：

```bash
# 成功数をカウント
ls -d output_* | wc -l

# 全銘柄の統計ファイルを結合
cat output_*/doc/zrd01.txt > all_stats.txt
```

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. ✅ コンパイルが正常に完了している
2. ✅ データファイルが正しいディレクトリにある
3. ✅ ディスク容量が十分にある（推奨: 50GB以上）
4. ✅ ログファイルでエラー詳細を確認

---

**作成日**: 2025年1月
**バージョン**: Phase 2 Multi-Stock (Single Program Batch Processing)
