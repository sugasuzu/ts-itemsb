#!/bin/bash

# ================================================================================
# 全銘柄自動処理スクリプト
# ================================================================================
#
# このスクリプトはNikkei 225銘柄を個別に順次処理します
# 各銘柄ごとに独立した出力ディレクトリが作成されます
#
# 使用方法:
#   bash run_all_stocks.sh
#
# ================================================================================

# 色設定
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ログディレクトリの作成
LOG_DIR="logs"
mkdir -p "$LOG_DIR"

# バッチログファイル
BATCH_LOG="$LOG_DIR/batch_$(date +%Y%m%d_%H%M%S).log"

# Nikkei 225銘柄リスト（main.cと同じ順序）
STOCK_CODES=(
    # 水産・農林業
    "1332" "1333"
    # 鉱業
    "1605"
    # 建設業
    "1721" "1801" "1802" "1803" "1925" "1928" "1963"
    # 食料品
    "2002" "2269" "2282" "2501" "2502" "2503" "2531" "2801" "2802" "2871" "2914"
    # 繊維製品
    "3086" "3401" "3402" "3407"
    # パルプ・紙
    "3861" "3863"
    # 化学
    "4005" "4021" "4042" "4043" "4061" "4063" "4151" "4183" "4188" "4202" "4204" "4208" "4272" "4324" "4452" "4502" "4503" "4506" "4507" "4519" "4523" "4543" "4568" "4578" "4612" "4631" "4661" "4681" "4704" "4751" "4901" "4911"
    # 医薬品
    "4502" "4503" "4506" "4507" "4519" "4523" "4543" "4568" "4578"
    # 石油・石炭製品
    "5001" "5002" "5019" "5020" "5101" "5108" "5201" "5202" "5214" "5232" "5233" "5301" "5332" "5333" "5401" "5406" "5411" "5541" "5631" "5703" "5706" "5707" "5711" "5713" "5714" "5801" "5802" "5803"
    # 鉄鋼
    "5401" "5406" "5411"
    # 非鉄金属
    "5631" "5703" "5706" "5707" "5711" "5713" "5714"
    # 金属製品
    "5801" "5802" "5803"
    # 機械
    "6103" "6113" "6178" "6201" "6268" "6301" "6302" "6305" "6326" "6361" "6367" "6471" "6472" "6473" "6479" "6501" "6502" "6503" "6504" "6506" "6586" "6594" "6645" "6701" "6702" "6723" "6724" "6752" "6753" "6758" "6762" "6841" "6857" "6861" "6902" "6920" "6923" "6952" "6954" "6963" "6971" "6976" "7003" "7004" "7011" "7012" "7013"
    # 電気機器
    "6501" "6502" "6503" "6504" "6506" "6586" "6594" "6645" "6701" "6702" "6723" "6724" "6752" "6753" "6758" "6762" "6841" "6857" "6861" "6902" "6920" "6923" "6952" "6954" "6963" "6971" "6976"
    # 輸送用機器
    "7003" "7004" "7011" "7012" "7013" "7201" "7202" "7203" "7205" "7267" "7269" "7270" "7272"
    # 精密機器
    "7731" "7733" "7735" "7741" "7751" "7752"
    # その他製品
    "7832" "7911" "7912" "7951"
    # 電気・ガス業
    "9501" "9502" "9503" "9531" "9532"
    # 陸運業
    "9001" "9005" "9007" "9008" "9020" "9021" "9022"
    # 海運業
    "9101" "9104" "9107"
    # 空運業
    "9201" "9202"
    # 倉庫・運輸関連業
    "9301" "9303" "9613"
    # 情報・通信業
    "4307" "4324" "4751" "9432" "9433" "9437" "9613" "9697" "9735" "9766" "9983" "9984"
    # 卸売業
    "8001" "8002" "8015" "8031" "8053" "8058" "8233" "8252" "8267" "8306" "8316" "8331" "8411"
    # 小売業
    "3086" "3099" "3382" "7453" "7606" "7608" "7611" "8233" "8252" "8267" "9983"
    # 銀行業
    "8301" "8303" "8304" "8306" "8308" "8309" "8316" "8331" "8354" "8355" "8411" "8473"
    # 証券、商品先物取引業
    "8473" "8601" "8604" "8628" "8630" "8697" "8750" "8766" "8802"
    # 保険業
    "8725" "8750" "8766" "8795"
    # その他金融業
    "8802"
    # 不動産業
    "8801" "8802" "8830"
    # サービス業
    "2413" "4307" "4324" "4661" "4751" "6178" "9432" "9433" "9437" "9613" "9697" "9735" "9766"
)

TOTAL_STOCKS=${#STOCK_CODES[@]}
SUCCESS_COUNT=0
FAILED_COUNT=0
START_TIME=$(date +%s)

echo ""
echo "========================================================================"
echo "  銘柄一括処理開始"
echo "========================================================================"
echo "総銘柄数: $TOTAL_STOCKS"
echo "ログファイル: $BATCH_LOG"
echo "開始時刻: $(date '+%Y-%m-%d %H:%M:%S')"
echo "========================================================================"
echo ""

# ログファイルにヘッダーを書き込み
{
    echo "========================================================================"
    echo "銘柄一括処理ログ"
    echo "開始時刻: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "総銘柄数: $TOTAL_STOCKS"
    echo "========================================================================"
    echo ""
} > "$BATCH_LOG"

# 各銘柄を順次処理
for idx in "${!STOCK_CODES[@]}"; do
    CODE="${STOCK_CODES[$idx]}"
    CODE_NUM=$((idx + 1))

    echo ""
    echo "========================================================================"
    printf "${BLUE}  [%d/%d] 処理中: %s${NC}\n" "$CODE_NUM" "$TOTAL_STOCKS" "$CODE"
    echo "========================================================================"

    # ログファイルにも記録
    {
        echo ""
        echo "========================================================================"
        echo "[$CODE_NUM/$TOTAL_STOCKS] 銘柄: $CODE"
        echo "開始: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "------------------------------------------------------------------------"
    } >> "$BATCH_LOG"

    # 処理開始時刻
    CODE_START=$(date +%s)

    # データファイルの存在確認
    DATA_FILE="nikkei225_data/gnminer_individual/${CODE}.txt"
    if [ ! -f "$DATA_FILE" ]; then
        printf "${RED}✗ エラー: データファイルが見つかりません: %s${NC}\n" "$DATA_FILE"
        echo "Result: FAILED (データファイル未発見)" >> "$BATCH_LOG"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        continue
    fi

    # 処理実行
    CODE_LOG="$LOG_DIR/${CODE}_$(date +%Y%m%d_%H%M%S).log"
    echo "  個別ログ: $CODE_LOG"

    if ./main "$CODE" > "$CODE_LOG" 2>&1; then
        # 処理終了時刻
        CODE_END=$(date +%s)
        CODE_ELAPSED=$((CODE_END - CODE_START))

        printf "${GREEN}✓ 成功: %s (%.0f秒)${NC}\n" "$CODE" "$CODE_ELAPSED"

        # ログに記録
        {
            echo "Result: SUCCESS"
            echo "処理時間: ${CODE_ELAPSED}秒"
            echo "終了: $(date '+%Y-%m-%d %H:%M:%S')"
        } >> "$BATCH_LOG"

        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        # 処理終了時刻
        CODE_END=$(date +%s)
        CODE_ELAPSED=$((CODE_END - CODE_START))

        printf "${RED}✗ 失敗: %s (%.0f秒)${NC}\n" "$CODE" "$CODE_ELAPSED"

        # ログに記録
        {
            echo "Result: FAILED"
            echo "処理時間: ${CODE_ELAPSED}秒"
            echo "終了: $(date '+%Y-%m-%d %H:%M:%S')"
        } >> "$BATCH_LOG"

        FAILED_COUNT=$((FAILED_COUNT + 1))
    fi

    # 進捗状況
    echo ""
    echo "------------------------------------------------------------------------"
    printf "進捗: %d/%d (%.1f%%)\n" "$CODE_NUM" "$TOTAL_STOCKS" "$(echo "scale=1; $CODE_NUM * 100 / $TOTAL_STOCKS" | bc)"
    printf "成功: ${GREEN}%d${NC} | 失敗: ${RED}%d${NC}\n" "$SUCCESS_COUNT" "$FAILED_COUNT"
    echo "------------------------------------------------------------------------"
done

# 全体の処理時間
END_TIME=$(date +%s)
TOTAL_ELAPSED=$((END_TIME - START_TIME))
TOTAL_MINUTES=$(echo "scale=1; $TOTAL_ELAPSED / 60" | bc)

echo ""
echo "========================================================================"
echo "  処理完了"
echo "========================================================================"
echo "総処理時間: ${TOTAL_ELAPSED}秒 (${TOTAL_MINUTES}分)"
printf "成功: ${GREEN}%d${NC} / %d 銘柄\n" "$SUCCESS_COUNT" "$TOTAL_STOCKS"
printf "失敗: ${RED}%d${NC} / %d 銘柄\n" "$FAILED_COUNT" "$TOTAL_STOCKS"
echo "成功率: $(echo "scale=1; $SUCCESS_COUNT * 100 / $TOTAL_STOCKS" | bc)%"
echo "バッチログ: $BATCH_LOG"
echo "========================================================================"
echo ""

# ログファイルにサマリーを追記
{
    echo ""
    echo "========================================================================"
    echo "処理完了サマリー"
    echo "========================================================================"
    echo "終了時刻: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "総処理時間: ${TOTAL_ELAPSED}秒 (${TOTAL_MINUTES}分)"
    echo "成功: $SUCCESS_COUNT / $TOTAL_STOCKS 銘柄"
    echo "失敗: $FAILED_COUNT / $TOTAL_STOCKS 銘柄"
    echo "成功率: $(echo "scale=1; $SUCCESS_COUNT * 100 / $TOTAL_STOCKS" | bc)%"
    echo "========================================================================"
} >> "$BATCH_LOG"

# 終了コード
if [ "$FAILED_COUNT" -eq 0 ]; then
    exit 0
else
    exit 1
fi
