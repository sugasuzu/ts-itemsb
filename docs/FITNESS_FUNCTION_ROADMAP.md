# 適応度関数の改善ロードマップ

**作成日:** 2025-11-10
**目的:** GNPによる時系列ルール発見システムの適応度関数を改善し、バランスの取れた高品質ルール発見を実現する

---

## 目次

1. [現状分析](#現状分析)
2. [研究目標との整合性](#研究目標との整合性)
3. [改善提案](#改善提案)
4. [実装ロードマップ](#実装ロードマップ)
5. [実験計画](#実験計画)
6. [期待される成果](#期待される成果)

---

## 現状分析

### 現在の適応度関数（2025-11-10時点）

```c
fitness =
    j2 × 1                              // 属性数
  + support × 3                         // サポート率
  + 8 / (σ + 0.5)                       // 低分散
  + concentration_bonus (0~25,000)      // 象限集中度
  + significance_bonus (0~20,000)       // 統計的有意性
  + 20                                  // 新規ルール
```

### 問題点

| 問題 | 詳細 | 影響 |
|------|------|------|
| **極端なスコア偏り** | 集中度+有意性が99.9%を占める | サポート率・分散が無視される |
| **過剰適合の許容** | 5マッチのルールでも高評価 | 実用性・信頼性が低い |
| **閾値との不整合** | 閾値は緩いが適応度は厳しい | 探索が非効率 |
| **階段関数の不連続性** | 59.9%と60.0%で5,000点差 | 段階的進化が阻害される |

### 現在の発見結果（BTC, 88ルール）

| 指標 | 最高値 | 平均値 | 問題点 |
|------|--------|--------|--------|
| 集中度 | 67.9% | ~45% | ✓ 目標達成 |
| \|mean\| | 0.22% | ~0.15% | ✗ 低すぎる（目標: ≥0.5%） |
| σ | 0.39% | ~0.40% | ✓ 許容範囲 |
| サポート | 28マッチ | ~30マッチ | △ やや少ない |

**総評:** 視覚的には成功（集中度67.9%）だが、統計的有意性が不十分

---

## 研究目標との整合性

### CLAUDE.mdの目標（再確認）

> **Core Goal: Discovery of Statistical Anomalies**
>
> Discover rare pattern groups where conditional mean is far from zero (statistically anomalous)
>
> Target:
> - Positive extreme: `mean >= +0.5%`
> - Negative extreme: `mean <= -0.5%`

### 4つのバランス目標

```
目標1: 分散が小さい (σ < 0.5%)
目標2: 象限に集中 (concentration ≥ 50%)
目標3: 平均が大きい (|mean| ≥ 0.5%)
目標4: サポートが多い (support ≥ 50マッチ)
```

### 現在の適応度の評価

| 目標 | 現在の重み | 評価 | 必要な対応 |
|------|-----------|------|-----------|
| 目標1 (分散小) | 0.03% | ❌ 無視可能 | **重み×25倍** |
| 目標2 (集中高) | 55.6% | ✅ 支配的 | 適度に抑制（÷2.5） |
| 目標3 (平均大) | 44.4% | ✅ 支配的 | 維持または強化 |
| 目標4 (サポート多) | 0.0007% | ❌ 無視可能 | **重み×100倍** |

---

## 改善提案

### 提案1: バランス型適応度関数（推奨★★★）

#### パラメータ設定

```c
/* ======================================
   Phase 1: フィルタ閾値（最低品質基準）
   ====================================== */

// 分散の閾値（厳格化）
#define Maxsigx 0.5                // 1.0 → 0.5

// 平均の閾値（厳格化）
#define Minmean 0.2                // 0.1 → 0.2

// 集中度の閾値（緩和）
#define MIN_CONCENTRATION 0.35     // 0.40 → 0.35

// サポート率の閾値（厳格化）
#define Minsup 0.0015              // 0.001 → 0.0015

// 【新規】最低マッチ数（絶対値制約）
#define MIN_SUPPORT_COUNT 20       // 最低20マッチ必須

/* ======================================
   Phase 2: 適応度の重み（バランス化）
   ====================================== */

// 基本スコアの重み（大幅増強）
#define FITNESS_ATTRIBUTE_WEIGHT 2         // 1 → 2
#define FITNESS_SUPPORT_WEIGHT 400         // 3 → 400 (133倍)
#define FITNESS_SIGMA_WEIGHT 200           // 8 → 200 (25倍)
#define FITNESS_SIGMA_OFFSET 0.30          // 0.50 → 0.30
#define FITNESS_NEW_RULE_BONUS 50          // 20 → 50

// 象限集中度ボーナス（大幅縮小）
#define CONCENTRATION_BONUS_1 200          // 500 → 200
#define CONCENTRATION_BONUS_2 800          // 2000 → 800
#define CONCENTRATION_BONUS_3 2500         // 8000 → 2500
#define CONCENTRATION_BONUS_4 5000         // 15000 → 5000
#define CONCENTRATION_BONUS_5 10000        // 25000 → 10000

// 統計的有意性ボーナス（やや縮小）
#define STATISTICAL_SIGNIFICANCE_BONUS_1 1000   // 2000 → 1000
#define STATISTICAL_SIGNIFICANCE_BONUS_2 4000   // 10000 → 4000
#define STATISTICAL_SIGNIFICANCE_BONUS_3 10000  // 20000 → 10000
```

#### 期待されるスコア分布

| 項目 | 現在 | 提案後 | 影響力の変化 |
|------|------|--------|-------------|
| サポート率 | 0.3点 | 2,280点 | 0.0007% → **11.4%** |
| 分散 | 13点 | 667点 | 0.03% → **3.3%** |
| 集中度 | 25,000点 | 10,000点 | 55.6% → **50.0%** |
| 統計的有意性 | 20,000点 | 10,000点 | 44.4% → **50.0%** |
| **合計** | ~45,000点 | ~20,000点 | - |

**新しいバランス:**
- 主要目標（集中度・有意性）: 100% (各50%)
- 品質保証（サポート・分散）: 14.7% (11.4% + 3.3%)

---

### 提案2: 連続関数化（推奨★★）

#### 現在の問題

```c
// 階段関数: 59.9%と60.0%で5,000点差
if (concentration >= 0.60)
    bonus = 10000;
else if (concentration >= 0.55)
    bonus = 5000;
```

#### 改善案: 線形補間による連続化

```c
double calculate_concentration_fitness_bonus(double concentration_ratio)
{
    if (concentration_ratio < 0.35)
        return 0.0;

    // 35-50%: 線形補間 (200 → 2500)
    if (concentration_ratio < 0.50) {
        double t = (concentration_ratio - 0.35) / 0.15;
        return 200 + t * 2300;
    }

    // 50-60%: 線形補間 (2500 → 10000)
    if (concentration_ratio < 0.60) {
        double t = (concentration_ratio - 0.50) / 0.10;
        return 2500 + t * 7500;
    }

    // 60%以上
    return 10000;
}
```

#### 効果

- 集中度の微妙な差も評価に反映
- 段階的進化が促進される
- 59.9%と60.0%の差が合理的（~75点）

---

### 提案3: サポート率の階層的評価（推奨★★★）

#### コンセプト

基本的な比例評価 + 高サポート率へのボーナス

```c
/* サポート率ボーナスの閾値 */
#define SUPPORT_BONUS_THRESHOLD_1 0.003   // 0.3%
#define SUPPORT_BONUS_THRESHOLD_2 0.005   // 0.5%
#define SUPPORT_BONUS_THRESHOLD_3 0.01    // 1.0%

#define SUPPORT_BONUS_1 500
#define SUPPORT_BONUS_2 1500
#define SUPPORT_BONUS_3 3000
```

#### 適応度計算での実装

```c
// 基本スコア（比例）
fitness += support * 300;

// ボーナス（階層的）
if (support >= 0.01)
    fitness += 3000;
else if (support >= 0.005)
    fitness += 1500;
else if (support >= 0.003)
    fitness += 500;
```

#### スコア例

| サポート率 | 基本スコア | ボーナス | 合計 |
|-----------|-----------|---------|------|
| 0.15% | 45点 | 0点 | 45点 |
| 0.3% | 90点 | 500点 | 590点 |
| 0.5% | 150点 | 1,500点 | 1,650点 |
| 1.0% | 300点 | 3,000点 | 3,300点 |

---

### 提案4: MIN_SUPPORT_COUNTの実装（推奨★★★）

#### 目的

過剰適合ルールを確実に排除

#### 実装方法

`check_rule_quality`関数の先頭に追加:

```c
int check_rule_quality(double *future_sigma_array,
                       double *future_mean_array,
                       double support,
                       int num_attributes,
                       int *quadrant_counts,
                       int matched_count)  // ← 引数追加
{
    // 【新規】最低マッチ数チェック
    if (matched_count < MIN_SUPPORT_COUNT) {
        return 0;  // 20マッチ未満は即棄却
    }

    // 既存のチェック処理...
    // ...
}
```

#### 効果

- サポート率が低くてもデータ数が多ければ通過する問題を解決
- 17,453件のデータで20マッチ = 実質的な最低サポート率0.115%
- 過剰適合の疑いがあるルールを確実に排除

---

### 提案5: 乗法的ボーナス（発展的★）

#### コンセプト

基本品質（サポート率・分散）が低い場合、主要ボーナス（集中度・有意性）を減衰

```c
// 基本品質を0-1の範囲で評価
double support_quality = min(support / 0.01, 1.0);
double sigma_quality = max(1.0 - sigma / Maxsigx, 0.0);
double base_quality = (support_quality + sigma_quality) / 2.0;

// 品質に応じた倍率（0.5-1.0）
double multiplier = 0.5 + base_quality * 0.5;

// 適応度計算
fitness =
    基本スコア +
    (concentration_bonus + significance_bonus) * multiplier;
```

#### 効果例

```
Rule A: サポート0.14%, σ=0.45%
  → multiplier = 0.56
  → 主要ボーナス = 11,000 × 0.56 = 6,160点

Rule B: サポート0.69%, σ=0.30%
  → multiplier = 0.775
  → 主要ボーナス = 12,500 × 0.775 = 9,688点
```

基本品質が低いルールは主要ボーナスが減衰される

---

## 実装ロードマップ

### Phase 1: 保守的調整（所要時間: 1日）

**目的:** 提案1（バランス型）を実装し、基本的な効果を検証

**実装内容:**
1. パラメータの変更（main.cの#define部分）
2. MIN_SUPPORT_COUNTの追加（check_rule_quality関数）
3. コンパイル・実行・結果確認

**期待される結果:**
- 発見ルール数: 88個 → 50-70個
- 最高|mean|: 0.22% → 0.4-0.6%
- 平均サポート: 30マッチ → 50マッチ

**判定基準:**
- ✅ 成功: |mean|≥0.5%のルールが5個以上発見される
- ⚠️ 要調整: |mean|は改善したがルール数が10個未満
- ❌ 失敗: |mean|が改善せず、ルール数のみ減少

---

### Phase 2: 連続関数化（所要時間: 0.5日）

**前提条件:** Phase 1が成功

**実装内容:**
1. `calculate_concentration_fitness_bonus`関数を線形補間版に変更
2. `calculate_significance_bonus`関数も同様に連続化（オプション）
3. 実行・結果比較

**期待される効果:**
- 段階的な進化パターンの観察（世代ごとの集中度推移が滑らか）
- 中間的な集中度（52-58%）のルールも適切に評価される

---

### Phase 3: サポート率ボーナス（所要時間: 0.5日）

**前提条件:** Phase 1または2が完了

**実装内容:**
1. サポート率の階層的ボーナスを追加
2. 適応度計算式に組み込む
3. 実行・サポート率分布を確認

**期待される効果:**
- 高サポート率ルール（≥0.5%）の発見数増加
- 平均サポート率の向上

---

### Phase 4: 乗法的ボーナス（所要時間: 1日、オプション）

**前提条件:** Phase 1-3の効果が不十分な場合のみ

**実装内容:**
1. 品質倍率の計算ロジックを追加
2. 適応度計算式を乗法形式に変更
3. 実行・詳細分析

**注意:** 複雑度が増すため、必要性を慎重に判断

---

## 実験計画

### 実験1: ベースライン（現在の設定）

**目的:** 比較基準の確立

**設定:**
- 現在のパラメータのまま実行
- BTC, 10試行, 201世代

**記録項目:**
- 発見ルール数、集中度分布、|mean|分布、σ分布、サポート率分布
- 世代ごとの適応度推移
- 最高集中度ルールの詳細

---

### 実験2: バランス型（Phase 1）

**目的:** 提案1の効果検証

**設定:**
```c
FITNESS_SUPPORT_WEIGHT = 400
FITNESS_SIGMA_WEIGHT = 200
CONCENTRATION_BONUS_5 = 10000
STATISTICAL_SIGNIFICANCE_BONUS_3 = 10000
MIN_SUPPORT_COUNT = 20
Maxsigx = 0.5
Minmean = 0.2
MIN_CONCENTRATION = 0.35
```

**比較項目:**
- ベースラインとの発見ルール数の差
- |mean|≥0.5%のルール数（目標: 5個以上）
- 平均サポート率の改善度

---

### 実験3: 連続関数型（Phase 2）

**目的:** 連続関数化の効果検証

**設定:**
- 実験2 + 連続関数化

**比較項目:**
- 世代ごとの集中度推移の滑らかさ
- 中間集中度（52-58%）のルール数

---

### 実験4: 統合型（Phase 1-3）

**目的:** 最終版の性能評価

**設定:**
- バランス型 + 連続関数 + サポート率ボーナス

**比較項目:**
- 4つの目標すべてを満たすルールの発見数
- パレート最適解の分析（集中度 vs |mean|の散布図）

---

### 実験5: 感度分析（オプション）

**目的:** パラメータの影響度を定量化

**方法:**
- 各パラメータを±20%変化させて10回実行
- 発見ルール数・品質指標への影響を測定

**分析:**
- どのパラメータが最も影響力が大きいか
- ロバスト性の評価

---

## 期待される成果

### 短期的成果（Phase 1-2完了時）

| 指標 | 現在 | 目標 | 期待値 |
|------|------|------|--------|
| 発見ルール数 | 88個 | 40-60個 | 50個 |
| 最高集中度 | 67.9% | 60%以上 | 62% |
| 最高\|mean\| | 0.22% | 0.5%以上 | 0.65% |
| 平均サポート | 30マッチ | 50マッチ以上 | 55マッチ |
| 平均σ | 0.40% | 0.35%以下 | 0.36% |

### 中期的成果（Phase 1-3完了時）

**定量的:**
- |mean|≥0.5% かつ 集中度≥55% のルールを10個以上発見
- サポート率≥0.5%のルールを20個以上発見
- 4つの目標すべてを満たすルールを3-5個発見

**定性的:**
- CLAUDE.mdの研究目標「統計的異常の発見」に合致
- 実用的なトレード戦略への応用可能性
- 論文としての説得力が向上

### 長期的成果（論文化）

**論文タイトル案:**
> "Balanced Fitness Function Design for Statistical Anomaly Discovery in Time-Series Data Mining using Genetic Network Programming"

**主要な貢献:**
1. **適応度設計の方法論:** 閾値と適応度の協調による探索と活用のバランス
2. **多目的最適化:** 4つの品質目標をバランスさせる実用的手法
3. **実証結果:** 暗号通貨市場での統計的異常パターンの発見

**比較実験の主張:**
```
従来手法（集中度偏重）:
  発見数: 多い (88個)
  視覚的明瞭性: 高い (集中度67.9%)
  統計的有意性: 低い (|mean|=0.22%)

提案手法（バランス型）:
  発見数: 適度 (50個)
  視覚的明瞭性: 高い (集中度62%)
  統計的有意性: 高い (|mean|=0.65%)
  実用性: 高い (サポート55マッチ)

→ 質・量・実用性のバランスが優れている
```

---

## 付録

### A. パラメータ一覧表

| パラメータ | 現在値 | Phase 1 | Phase 2 | Phase 3 |
|-----------|--------|---------|---------|---------|
| `Maxsigx` | 1.0 | 0.5 | 0.5 | 0.5 |
| `Minmean` | 0.1 | 0.2 | 0.2 | 0.2 |
| `MIN_CONCENTRATION` | 0.40 | 0.35 | 0.35 | 0.35 |
| `Minsup` | 0.001 | 0.0015 | 0.0015 | 0.0015 |
| `MIN_SUPPORT_COUNT` | - | 20 | 20 | 20 |
| `FITNESS_SUPPORT_WEIGHT` | 3 | 400 | 400 | 300 |
| `FITNESS_SIGMA_WEIGHT` | 8 | 200 | 200 | 200 |
| `CONCENTRATION_BONUS_5` | 25000 | 10000 | 10000 | 10000 |
| `STATISTICAL_SIGNIFICANCE_BONUS_3` | 20000 | 10000 | 10000 | 10000 |
| サポート率ボーナス | なし | なし | なし | あり |
| 連続関数化 | なし | なし | あり | あり |

### B. 関連ファイル

- `main.c` (lines 36-118): パラメータ定義
- `main.c` (lines 2206-2213): 適応度計算（新規ルール）
- `main.c` (lines 2345-2351): 適応度計算（重複ルール）
- `main.c` (lines 462-476): 集中度ボーナス関数
- `main.c` (lines 448-460): 統計的有意性ボーナス関数
- `main.c` (lines 1833-1895): ルール品質チェック関数

### C. 参考文献

1. CLAUDE.md: 研究目標の定義
2. 適応度関数の議論（本セッション）: 問題点の特定と改善提案
3. Rule 83分析: 集中度67.9%の実例
4. Maxsigx分析: ±1σ楕円との関係

---

## 改訂履歴

| 日付 | 版 | 変更内容 |
|------|-----|---------|
| 2025-11-10 | 1.0 | 初版作成 |

---

**次のステップ:** Phase 1の実装から開始することを推奨
